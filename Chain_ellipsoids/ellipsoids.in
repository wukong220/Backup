#!/bin/sh

# Setup
echo		screen
units           lj
dimension       2
boundary        p p p
atom_style      hybrid angle ellipsoid
newton          off

# settings
##################################################################
# LJ potential of beads of chain 
variable	Rc_s equal 3			# Soft potential cutoff distance/Interval
variable	Pre_soft equal ramp(0.0,300.0)	# Soft prefactor
variable	Rc_lj equal 1.12246		# LJ potential cutoff of beeds
variable	Epsilon equal 4*1.0		# 4 * LJ potential depth * 4
variable	Sigma equal 2*0.5		# 2 * LJ potential Radius of beads * 2

# LJ potential of obstacle with beads
variable	Ro equal 2*5.0			# 2 * LJ potential Radius of obstacles/Size * 2 
variable	Rc_o equal v_Ro*v_Rc_lj		# LJ potential cutoff of obstacles
variable	R12 equal (v_Sigma+v_Ro)/2.0	# LJ potential between beads and obstacles  
variable	Rc_12 equal v_R12*v_Rc_lj	# LJ potential cutoff of beads and obstacles

# Spring and bending potential of chain
variable	Ks equal 2*350.0	# 2 * Spring efficiency * 2 
variable	R0 equal 1.05		# Spring equilibrium distance
variable	Kb equal 2*50.0		# 2 * Bending efficiency * 2
variable	Theta0 equal 180.0	# Bending equilibrium degree
variable	Fa equal 5.0		# Active Force

# Langevin equation
variable	Bin equal 0.8		# Neighbor bin
variable	T0 equal 1.0		# Original temperature 
variable	Te equal 1.0		# End temperature
variable	Gamma equal 0.001	# Friction efficiency 
#variable	Rand equal ramp(18238, 765234746)	# Seed of white noise
variable	Seed equal 765234746

# run time
variable	dt equal 0.001		# Timestep
variable	Nf_equ equal 10		# number of frames
variable	Tpf_equ equal 5000
variable	Tequ equal ${Nf_equ}*${Tpf_equ}

variable	Nf_equ0 equal 20		# number of frames
variable	Tequ0 equal ${Nf_equ0}*${Tpf_equ}

variable	Nf_run equal 1000	
variable	Tpf_run equal 100000
variable	Ttotal equal ${Nf_run}*${Tpf_run}	# Total run steps
##################################################################

read_data       chain.data
read_data		ellipsoids.data add append offset 1 0 0 0 0
# read_restart	restart_equ01.data

# groups
group			chain type 1
group			obs type 2
variable     dof equal count(chain)+2

set 	     type 1 mass 1.0
set 	     type 2 mass 1.5
set			type 1 shape 1 1 1
set			type 2 shape 4 2 2
set 		group obs quat/random 18238

reset_timestep    0
comm_modify vel yes

velocity		all create 2.4 87287 loop geom
# potential data
##################################################################
pair_style   gayberne 1.0 3.0 1.0 4.0 #hybrid/overlay lj/cut ${Rc_lj} gayberne 1.0 3.0 1.0 4.0
#pair_coeff   1 1 lj/cut 3.0 1.0
pair_coeff   1 1 3.0 1 1 1 1 1 1 1 2.5
pair_coeff   1 2 3.0 3 1 1 1 1 1 1
pair_coeff   2 2 ${Epsilon} 3 1 1 0.2 1 1 1

# Bond potential
bond_style      harmonic
bond_coeff      1 ${Ks} ${R0}
# special_bonds   lj/coul 1.0 1.0 1.0

# Angle potential
angle_style     actharmonic
angle_coeff     1 ${Kb} ${Theta0} 0.0
##################################################################


# minimize energy
minimize      1.0e-4 1.0e-6 1000 10000

# neighbor
neighbor	${Bin} bin
neigh_modify	every 1 delay 0 check yes exclude group chain obs

# run dynamical equation
##################################################################
timestep        ${dt}
thermo		1000

#thermo_style custom step c_rot epair etotal press vol #c_shape[1]

#dump            2 all custom 1000 ellipse_init01.lammpstrj id type x y z vx vy vz
#fix	    	 1 obs npt/asphere temp 1.0 1.0 0.1 iso 0.0 1.0 0.1 tchain 1 pchain 0 mtk no
#compute_modify 1_temp extra/dof ${dof}

fix		 	10 all deform 1 x final 0.0 70.0 y final 0.0 70.0  units box remap x
fix			11 obs nve/limit 0.1
fix			12 chain nve/limit 0.08
fix	     	13 obs nve/asphere 
#fix      	13 chain langevin ${T0} ${Te} ${Gamma} ${Seed} zero yes
fix	     	2  all enforce2d

compute	     orient all property/atom quati quatj quatk quatw
compute		shape all property/atom shapex shapey shapez
#compute	     rot all temp/asphere
#compute_modify rot extra/dof ${dof}
dump		1 all custom ${Tpf_equ} ellipse_init00.lammpstrj id type x y z &
			c_orient[1] c_orient[2] c_orient[3] c_orient[4] c_shape[1] c_shape[2] c_shape[3] 
dump_modify     1 sort id

# equilibrate to shrink box around dilute system
run	     ${Tequ}
run		${Tequ}

# prepation for next run
reset_timestep		0
unfix		10
unfix		11
unfix		13
set			type 2 shape 3 1 1

# requilibration run2 on dense system 
# pair potential
pair_style   hybrid/overlay lj/cut ${Rc_lj} soft ${Rc_s}
#pair_coeff   1 1 0.0 1
#pair_coeff   1 2 0.0 
#pair_coeff   2 2 0.0
pair_coeff   1 1 lj/cut 3.0 1.0
pair_coeff   1 2 soft 0.0
pair_coeff   2 2 soft 0.0
fix 		soft1 all adapt 1 pair soft a 1 2 v_Pre_soft

# minimize energy
minimize      1.0e-4 1.0e-6 1000 10000

# neighbor
neigh_modify	every 1 delay 0 check yes exclude none

fix      	10 chain langevin 10.0 10.0 ${Gamma} ${Seed} zero yes

run	     ${Tequ0}
reset_timestep		0
unfix		soft1
unfix		10
unfix		12
undump		1
# data gathering run 
# pair potential
pair_style   hybrid/overlay lj/cut ${Rc_lj} gayberne 1.0 3.0 1.0 3.0
pair_coeff   1 1 lj/cut 3.0 1.0
pair_coeff   1 2 gayberne 3.0 1.0 1 1 1 1 1 1
pair_coeff   2 2 none

# Angle potential
angle_style     actharmonic
angle_coeff     1 ${Kb} ${Theta0} ${Fa}

fix			11 chain nve
fix      	10 chain langevin  ${T0} ${Te} ${Gamma} ${Seed} zero yes

# compute and output
thermo		10000
dump		1 all custom ${Tpf_run} 50_5.0.lammpstrj id type x y z vx vy vz &
			c_orient[1] c_orient[2] c_orient[3] c_orient[4] c_shape[1] c_shape[2] c_shape[3] 
dump_modify     1 sort id

dump		2 all custom ${Tpf_run} 50_5.0u.lammpstrj id type xu yu zu vx vy vz &
			c_orient[1] c_orient[2] c_orient[3] c_orient[4] c_shape[1] c_shape[2] c_shape[3] 
dump_modify     2 sort id


#dump			1 all custom 10000 chains_0.07_900.lammpstrj id type x y z vx vy vz
#dump_modify     1 sort id

# dump            2 all custom 1000 cu_v_init.lammpstrj id type xu yu zu vx vy vz
# dump_modify     2 sort id

# dump            3 all custom 1000 force_init.lammpstrj id type xu yu zu fx fy fz
# dump_modify     3 sort id

#run
restart         100000 restart_run1.data restart_run2.data
run		${Ttotal}
write_restart	restart_run00.data
##################################################################